<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package Language="1033" Manufacturer="Acme Corporation" Name="04_PowerShellPreconditionCustomAction" UpgradeCode="{FFA6A5DE-5551-4A45-B3B5-0C2F78E605AF}" Version="1.0.0.0" InstallerVersion="200"><MajorUpgrade DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit." />

    <MediaTemplate EmbedCab="yes" />

    <Property Id="POWERSHELLVERSION">
      <RegistrySearch Id="POWERSHELLVERSION" Type="raw" Root="HKLM" Key="SOFTWARE\Microsoft\PowerShell\3\PowerShellEngine" Name="PowerShellVersion" />
    </Property>

    <Property Id="POWERSHELLEXE">
      <RegistrySearch Id="POWERSHELLEXE" Type="raw" Root="HKLM" Key="SOFTWARE\Microsoft\PowerShell\1\ShellIds\Microsoft.PowerShell" Name="Path" />
    </Property>

    <Launch Condition="Installed OR (POWERSHELLEXE AND POWERSHELLVERSION &gt;= &quot;3.0&quot;)" Message="You must have PowerShell 3.0 or higher." />

    <Property Id="MY_PROPERTY" Value="default value" />

    

    <ComponentGroup Directory="MY_INSTALL_LOCATION" Id="ProductComponentGroup">
      <Component Id="cmp_FileToInstall_txt">
        <File Id="FileToInstall.txt" KeyPath="yes" Source="FileToInstall.txt"></File>
      </Component>
      <Component Id="cmp_MyAppendScript_ps1">
        <File Id="MyAppendScript.ps1" KeyPath="yes" Source="MyAppendScript.ps1"></File>
      </Component>
      <Component Id="cmp_RegistryEntry">
        <RegistryKey Root="HKLM" Key="Software\[Manufacturer]\[ProductName]">
          <RegistryValue KeyPath="yes" Type="string" Name="My property" Value="[MY_PROPERTY]" />
        </RegistryKey>
      </Component>
    </ComponentGroup>

    <SetProperty Id="CA_AppendTextUsingPowerShell" Before="CA_AppendTextUsingPowerShell" Sequence="execute" Value="&quot;[POWERSHELLEXE]&quot; -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -File &quot;[MY_INSTALL_LOCATION]MyAppendScript.ps1&quot; -propertyValue &quot;[MY_PROPERTY]&quot;" />

    <CustomAction Id="CA_AppendTextUsingPowerShell" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

    <InstallExecuteSequence>
      <Custom Action="CA_AppendTextUsingPowerShell" After="InstallFiles" Condition="NOT Installed AND NOT WIX_UPGRADE_DETECTED" />
    </InstallExecuteSequence>

    <Feature Id="HelloWorldFeature">
      <ComponentGroupRef Id="ProductComponentGroup" />
    </Feature>

  
      <StandardDirectory Id="ProgramFilesFolder">
        <Directory Id="MY_INSTALL_LOCATION" Name="04_PowerShellPreconditionCustomAction" />
      </StandardDirectory>
    </Package>
</Wix>
